<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="ZhenYu">
    
    <title>
        
            后端开发实践系列——开发者的第0个迭代 |
        
        NoDDD
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"noddd.cn","root":"/","language":"zh-CN"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                NoDDD
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags/go"
                            >
                                GO
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags/DDD/"
                            >
                                DDD
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags/go">GO</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags/DDD/">DDD</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">后端开发实践系列——开发者的第0个迭代</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">ZhenYu</span>
                        
                            <span class="author-label">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2020-12-15 20:56:05
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/DDD/">DDD</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>6.5k 字</span>
        </span>
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>在ThoughtWorks，我从零开始搭建了不少软件项目，其中包含了基础代码框架和持续集成基础设施等，这些内容在敏捷开发中通常被称为“第0个迭代”要做的事情。但是，当项目运行了一段时间之后再来反观，我总会发现一些不足的地方，要么测试分类没有分好，要么基本的编码架子没有考虑周全。</p>
<p>另外，我在工作中也会接触到很多既有项目，公司内部和外部的都有，多数项目的编码实践我都是不满意的。比如，我曾经新加入一个项目的时候，前前后后请教了3位同事才把该项目在本地运行起来；又比如在另一项目中，我发现前端请求对应的Java类命名规范不统一，有被后缀为Request的，也有被后缀为Command的。</p>
<p>再者，工作了这么多年之后，我越来越发现基础知识以及系统性学习的重要性。诚然，技术框架的发展使得我们可以快速地实现业务功能，但是当软件出了问题之后有时却需要将各方面的知识融会贯通并在大脑里综合反应才能找到解决思路。</p>
<p>基于以上，我希望整理出一套公共性的项目模板出来，旨在尽量多地包含日常开发之所需，减少开发者的重复性工作以及提供一些最佳实践。对于后端开发而言，我选择了当前被行业大量使用的Spring Boot，基于此整理出了一套公共的、基础性的实践方式，在结合了自己的经验以及其他项目的优秀实践之后，总结出本文以飨开发者。</p>
<p>本文以一个简单的电商订单系统为例，源代码请访问：</p>
<blockquote>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/e-commerce-sample/order-backend" >https://github.com/e-commerce-sample/order-backend<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<p>所使用的技术栈主要包括：Spring Boot、Gradle、MySQL、Junit 5、Rest Assured、Docker等。</p>
<h3 id="第一步：从写好README开始"><a href="#第一步：从写好README开始" class="headerlink" title="第一步：从写好README开始"></a>第一步：从写好README开始</h3><p>一份好的README可以给人以项目全景概览，可以使新人快速上手项目，可以降低沟通成本。同时，README应该简明扼要，条理清晰，建议包含以下方面：</p>
<ul>
<li>项目简介：用一两句话简单描述该项目所实现的业务功能；</li>
<li>技术选型：列出项目的技术栈，包括语言、框架和中间件等；</li>
<li>本地构建：列出本地开发过程中所用到的工具命令；</li>
<li>领域模型：核心的领域概念，比如对于示例电商系统来说有Order、Product等；</li>
<li>测试策略：自动化测试如何分类，哪些必须写测试，哪些没有必要写测试；</li>
<li>技术架构：技术架构图；</li>
<li>部署架构：部署架构图；</li>
<li>外部依赖：项目运行时所依赖的外部集成方，比如订单系统会依赖于会员系统；</li>
<li>环境信息：各个环境的访问方式，数据库连接等；</li>
<li>编码实践：统一的编码实践，比如异常处理原则、分页封装等；</li>
<li>FAQ：开发过程中常见问题的解答。</li>
</ul>
<p>需要注意的是，README中的信息可能随着项目的演进而改变（比如引入了新的技术栈或者加入了新的领域模型），因此也是需要持续更新的。虽然我们知道，软件文档的一个痛点便是无法与项目实际进展保持同步，但是就README这点信息来讲，还是建议开发者们不要吝啬那一点点敲键盘的时间。</p>
<p>此外，除了保持README的持续更新，一些重要的架构决定可以通过示例代码的形式记录在代码库中，新开发者可以通过直接阅读这些示例代码快速了解项目的通用实践方式以及架构选择，请参考ThoughtWorks的<a class="link"   target="_blank" rel="noopener" href="https://www.thoughtworks.com/radar/techniques/lightweight-architecture-decision-records" >技术雷达<i class="fas fa-external-link-alt"></i></a>。</p>
<h3 id="一键式本地构建"><a href="#一键式本地构建" class="headerlink" title="一键式本地构建"></a>一键式本地构建</h3><p>为了避免诸如前文中所提到的“请教了3位同事才本地构建成功”的尴尬，为了减少“懒惰”的程序员们的手动操作，也为了为所有开发者提供一种一致的开发体验，我们希望用一个命令就可以完成所有的事情。这里，对于不同的场景我总结出了以下命令：</p>
<ul>
<li>生成IDE工程：<code>idea.sh</code>，生成IntelliJ工程文件并自动打开IntelliJ</li>
<li>本地运行：<code>run.sh</code>，本地启动项目，自动启动本地数据库，监听调试端口5005</li>
<li>本地构建：<code>local-build.sh</code>，只有本地构建成功才能提交代码</li>
</ul>
<p>以上3个命令基本上可以完成日常开发之所需，此时，对于新人的开发流程大致为：</p>
<ol>
<li>拉取代码；</li>
<li>运行<code>idea.sh</code>，自动打开IntelliJ；</li>
<li>编写代码，包含业务代码和自动化测试；</li>
<li>运行<code>run.sh</code>，进行本地调试或必要的手动测试(本步骤不是必需)；</li>
<li>运行<code>local-build.sh</code>，完成本地构建；</li>
<li>再次拉取代码，保证<code>local-build.sh</code>成功，提交代码。</li>
</ol>
<p>事实上，这些命令脚本的内容非常简单，比如<code>run.sh</code>文件内容为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">./gradlew clean bootRun</span><br></pre></td></tr></table></figure>

<p>然而，这种显式化的命令却可以减少新人的恐惧感，因为他们只需要知道运行这3个命令就可以搞开发了。另外，一个小小的细节：本地构建的<code>local-build.sh</code>命令本来可以重命名为更简单的<code>build.sh</code>，但是当我们在命令行中使用Tab键自动补全的时候，会发现自动补全到了<code>build</code>目录，而不是<code>build.sh</code>命令，并不方便，因此命名为了<code>local-build.sh</code>。细节虽小，但是却体现了一个宗旨，即我们希望给开发者一种极简的开发体验，我把这些看似微不足道的东西称作是对程序员的“人文关怀”。</p>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p>Maven所提倡的<a class="link"   target="_blank" rel="noopener" href="https://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html" >目录结构<i class="fas fa-external-link-alt"></i></a>当前已经成为事实上的行业标准，Gradle在默认情况下也采用了Maven的目录结构，这对于多数项目来说已经足够了。此外，除了Java代码，项目中还存在其他类型的文件，比如Gradle插件的配置、工具脚本和部署配置等。无论如何，项目目录结构的原则是简单而有条理，不要随意地增加多余的文件夹，并且也需要及时重构。</p>
<p>在示例项目中，顶层只有2个文件夹，一个是用于放置Java源代码和项目配置的<code>src</code>文件夹，另一个是用于放置所有Gradle配置的<code>gradle</code>文件夹，此外，为了方便开发人员使用，将上文提到的3个常用脚本直接放到根目录下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">└── order-backend</span><br><span class="line">    ├── gradle // 文件夹，用于放置所有Gradle配置</span><br><span class="line">    ├── src // 文件夹，Java源代码</span><br><span class="line">    ├── idea.sh //生成IntelliJ工程</span><br><span class="line">    ├── local-build.sh // 提交之前的本地构建</span><br><span class="line">    └── run.sh // 本地运行</span><br></pre></td></tr></table></figure>

<p>对于<code>gradle</code>而言，我们刻意地将Gradle插件脚本与插件配置放到了一起，比如Checkstyle：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├── gradle</span><br><span class="line">│   ├── checkstyle</span><br><span class="line">│   │   ├── checkstyle.gradle</span><br><span class="line">│   │   └── checkstyle.xml</span><br></pre></td></tr></table></figure>

<p>事实上，在默认情况下Checkstyle插件会从项目根目录下的<code>config</code>目录查找<code>checkstyle.xml</code>配置文件，但是这一方面增加了多余的文件夹，另一方面与该插件相关的设施分散在了不同的地方，违背了广义上的内聚原则。</p>
<h3 id="基于业务分包"><a href="#基于业务分包" class="headerlink" title="基于业务分包"></a>基于业务分包</h3><p>早年的Java分包方式通常是基于技术的，比如与domain包平级的有controller包、service包和infrastructure包等。这种方式当前并不被行业所推崇，而是应该首先基于业务分包。比如，在订单示例项目中，有两个重要的领域对象<code>Order</code>和<code>Product</code>（在<a class="link"   target="_blank" rel="noopener" href="https://insights.thoughtworks.cn/backend-development-iteration0/[https://en.wikipedia.org/wiki/Domain-driven_design](https://en.wikipedia.org/wiki/Domain-driven_design)" >DDD<i class="fas fa-external-link-alt"></i></a>中称为<a class="link"   target="_blank" rel="noopener" href="https://insights.thoughtworks.cn/backend-development-iteration0/[https://martinfowler.com/bliki/DDD_Aggregate.html](https://martinfowler.com/bliki/DDD_Aggregate.html)" >聚合根<i class="fas fa-external-link-alt"></i></a>），所有的业务都围绕它们展开，因此分别创建order包和product包，再分别在包下创建与之相关的各个子包。此时的order包如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">├── order</span><br><span class="line">│   ├── OrderApplicationService.java</span><br><span class="line">│   ├── OrderController.java</span><br><span class="line">│   ├── OrderNotFoundException.java</span><br><span class="line">│   ├── OrderRepository.java</span><br><span class="line">│   ├── OrderService.java</span><br><span class="line">│   └── model</span><br><span class="line">│       ├── Order.java</span><br><span class="line">│       ├── OrderFactory.java</span><br><span class="line">│       ├── OrderId.java</span><br><span class="line">│       ├── OrderItem.java</span><br><span class="line">│       └── OrderStatus.java</span><br></pre></td></tr></table></figure>

<p>可以看到，在order包下我们直接放置了<code>OrderController</code>和<code>OrderRepository</code>等类，而没有必要再为这些类划分单独的子包。而对于领域模型Order来讲，由于包含了多个对象，因此基于内聚性原则将它们归到model包中。但是这并不是一个必须，如果业务足够简单，我们甚至可以将所有类直接放到业务包下，product包便是如此：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">└── product</span><br><span class="line">    ├── Product.java</span><br><span class="line">    ├── ProductApplicationService.java</span><br><span class="line">    ├── ProductController.java</span><br><span class="line">    ├── ProductId.java</span><br><span class="line">    └── ProductRepository.java</span><br></pre></td></tr></table></figure>

<p>在编码实践中，我们总是基于一个业务用例来实现代码，在技术分包场景下，我们需要在分散的各包中来回切换，增加了代码导航的成本；另外，代码提交的变更内容也是散落的，在查看代码提交历史时，无法直观的看出该次提交是关于什么业务功能的。在业务分包下，我们只需要在单个统一的包下修改代码，减少了代码导航成本；另外一个好处是，如果哪天我们需要将某个业务迁移到另外的项目（比如识别出了独立的微服务），那么直接整体移动业务包即可。</p>
<p>当然，基于业务分包并不意味着所有的代码都必须囿于业务包下，这里的逻辑是：优先进行业务分包，然后对于一些不隶属于任何业务的代码可以单独分包，比如一些util类、公共配置等。比如我们依然可以创建一个common包，下面放置了Spring公共配置、异常处理框架和日志等子包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">└── common</span><br><span class="line">    ├── configuration</span><br><span class="line">    ├── exception</span><br><span class="line">    ├── loggin</span><br><span class="line">    └── utils</span><br></pre></td></tr></table></figure>

<h3 id="自动化测试分类"><a href="#自动化测试分类" class="headerlink" title="自动化测试分类"></a>自动化测试分类</h3><p>在当前的微服务和前后端分离的开发模式下，后端项目仅提供纯粹的业务API，而不包含UI逻辑，因此后端项目不会再包含诸如WebDriver的重量级端到端测试。同时，后端项目作为向外提供业务功能的独立运行单元，在API级别也应该有相应的测试。</p>
<p>此外，程序中有些框架性代码，要么是诸如Controller之类的技术性框架代码，要么是基于某种架构风格的代码（比如DDD实践中的<a class="link"   target="_blank" rel="noopener" href="https://insights.thoughtworks.cn/backend-development-iteration0/[https://blog.arkency.com/application-service-ruby-rails-ddd/](https://blog.arkency.com/application-service-ruby-rails-ddd/)" >ApplicationService<i class="fas fa-external-link-alt"></i></a>），这些代码一方面并不包含业务逻辑，一方面是很薄的一个抽象层（即实现相对简单），用单元测试来覆盖显得没有必要，因此笔者的观点是可以不为此编写单独的单元测试。再者，程序中有些重要的组件性代码，比如访问数据库的Repository或者分布式锁，使用单元测试实际上“测不到点上”，而使用API测试又显得在分类逻辑上不合理，为此我们可以专门创建一种测试类型谓之组件测试。</p>
<p>基于以上，我们可以对自动化测试做个分类：</p>
<ul>
<li>单元测试：核心的领域模型，包括领域对象(比如Order类)，Factory类，领域服务类等；</li>
<li>组件测试：不适合写单元测试但是又必须测试的类，比如Repository类，在有些项目中，这种类型测试也被称为集成测试；</li>
<li>API测试：模拟客户端测试各个API接口，需要启动程序。</li>
</ul>
<p>Gradle在默认情况下只提供<code>src/test/java</code>目录用于测试，对于以上3种类型的测试，我们需要将它们分开以便于管理（也是职责分离的体现）。为此，可以通过Gradle提供的SourceSets对测试代码进行分类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sourceSets &#123;</span><br><span class="line">    componentTest &#123;</span><br><span class="line">        compileClasspath += sourceSets.main.output + sourceSets.test.output</span><br><span class="line">        runtimeClasspath += sourceSets.main.output + sourceSets.test.output</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    apiTest &#123;</span><br><span class="line">        compileClasspath += sourceSets.main.output + sourceSets.test.output</span><br><span class="line">        runtimeClasspath += sourceSets.main.output + sourceSets.test.output</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此，3种类型的测试可以分别编写在以下目录：</p>
<ul>
<li>单元测试：<code>src/test/java</code></li>
<li>组件测试：<code>src/componentTest/java</code></li>
<li>API测试：<code>src/apiTest/java</code></li>
</ul>
<p>需要注意的是，这里的API测试更多强调的是对业务功能的测试，有些项目中可能还会存在契约测试和安全测试等，虽然从技术上讲都是对API的访问，但是这些测试都是单独的关注点，因此建议分开对待。</p>
<p>值得一提的是，由于组件测试和API测试需要启动程序，也即需要准备好本地数据库，我们采用了Gradle的<a target="_blank" rel="noopener" href="https://plugins.gradle.org/plugin/com.avast.gradle.docker-compose"><code>docker-compose</code></a>插件(或者<a class="link"   target="_blank" rel="noopener" href="https://github.com/GoogleContainerTools/jib" >jib插件<i class="fas fa-external-link-alt"></i></a>)，该插件会在运行测试之前自动运行Docker容器（比如MySQL）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#x27;docker-compose&#x27;</span><br><span class="line"></span><br><span class="line">dockerCompose &#123;</span><br><span class="line">    useComposeFiles = [&#x27;docker/mysql/docker-compose.yml&#x27;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bootRun.dependsOn composeUp</span><br><span class="line">componentTest.dependsOn composeUp</span><br><span class="line">apiTest.dependsOn composeUp</span><br></pre></td></tr></table></figure>

<p>更多的测试分类配置细节，比如<a class="link"   target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/jacoco_plugin.html" >JaCoCo<i class="fas fa-external-link-alt"></i></a>测试覆盖率配置等，请参考本文的示例项目代码。对Gradle不熟悉的读者可以参考笔者的<a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/CloudTeng/p/3417762.html" >Gradle学习系列<i class="fas fa-external-link-alt"></i></a>文章。</p>
<h3 id="日志处理"><a href="#日志处理" class="headerlink" title="日志处理"></a>日志处理</h3><p>在日志处理中，除了完成基本配置外，还有2个需要考虑的点：</p>
<ul>
<li>在日志中加入请求标识，便于链路追踪。在处理一个请求的过程中有时会输出多条日志，如果每条日志都共享统一的请求ID，那么在日志追踪时会更加方便。此时，可以使用Logback原生提供的MDC(Mapped Diagnostic Context)功能，创建一个RequestIdMdcFilter：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="params"><span class="function">                                HttpServletResponse response,</span></span></span><br><span class="line"><span class="params"><span class="function">                                FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//request id in header may come from Gateway, eg. Nginx</span></span><br><span class="line">    String headerRequestId = request.getHeader(HEADER_X_REQUEST_ID);</span><br><span class="line">    MDC.put(REQUEST_ID, isNullOrEmpty(headerRequestId) ? newUuid() : headerRequestId);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        clearMdc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>集中式日志管理，在多节点部署的场景下，各个节点的日志是分散的，为此可以引入诸如ELK之类的工具将日志统一输出到ElasticSearch中。本文的示例项目使用了RedisAppender将日志输出到Logstash：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;REDIS&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cwbase.logback.RedisAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tags</span>&gt;</span>ecommerce-order-backend-$&#123;ACTIVE_PROFILE&#125;<span class="tag">&lt;/<span class="name">tags</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">host</span>&gt;</span>elk.yourdomain.com<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>6379<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>whatever<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>ecommerce-ordder-log<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mdc</span>&gt;</span>true<span class="tag">&lt;/<span class="name">mdc</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>redis<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当然，统一日志的方案还有很多，比如Splunk和Graylog等。</p>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>在设计异常处理的框架时，需要考虑以下几点：</p>
<ul>
<li>向客户端提供格式统一的异常返回</li>
<li>异常信息中应该包含足够多的上下文信息，最好是结构化的数据以便于客户端解析</li>
<li>不同类型的异常应该包含唯一标识，以便客户端精确识别</li>
</ul>
<p>异常处理通常有两种形式，一种是层级式的，即每种具体的异常都对应了一个异常类，这些类最终继承自某个父异常；另一种是单一式的，即整个程序中只有一个异常类，再以一个字段来区分不同的异常场景。层级式异常的好处是能够显式化异常含义，但是如果层级设计不好可能导致整个程序中充斥着大量的异常类；单一式的好处是简单，而其缺点在于表意性不够。</p>
<p>本文的示例项目使用了层级式异常，所有异常都继承自一个AppException：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AppException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ErrorCode code;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; data = newHashMap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，<code>ErrorCode</code>枚举中包含了异常的唯一标识、HTTP状态码以及错误信息；而<code>data</code>字段表示各个异常的上下文信息。</p>
<p>在示例系统中，在没有找到订单时抛出异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderNotFoundException</span> <span class="keyword">extends</span> <span class="title">AppException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderNotFoundException</span><span class="params">(OrderId orderId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(ErrorCode.ORDER_NOT_FOUND, ImmutableMap.of(<span class="string">&quot;orderId&quot;</span>, orderId.toString()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在返回异常给客户端时，通过一个ErrorDetail类来统一异常格式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorDetail</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ErrorCode code;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String path;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Instant timestamp;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; data = newHashMap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终返回客户端的数据为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  requestId: <span class="string">&quot;d008ef46bb4f4cf19c9081ad50df33bd&quot;</span>,</span><br><span class="line">  error: &#123;</span><br><span class="line">    code: <span class="string">&quot;ORDER_NOT_FOUND&quot;</span>,</span><br><span class="line">    status: <span class="number">404</span>,</span><br><span class="line">    message: <span class="string">&quot;没有找到订单&quot;</span>,</span><br><span class="line">    path: <span class="string">&quot;/order&quot;</span>,</span><br><span class="line">    timestamp: <span class="number">1555031270087</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      orderId: <span class="string">&quot;123456789&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>ORDER_NOT_FOUND</code>与<code>data</code>中的数据结构是一一对应的，也即对于客户端来讲，如果发现了<code>ORDER_NOT_FOUND</code>，那么便可确定<code>data</code>中一定存在<code>orderId</code>字段，进而完成精确的结构化解析。</p>
<h3 id="后台任务与分布式锁"><a href="#后台任务与分布式锁" class="headerlink" title="后台任务与分布式锁"></a>后台任务与分布式锁</h3><p>除了即时完成客户端的请求外，系统中通常会有一些定时性的例行任务，比如定期地向用户发送邮件或者运行数据报表等；另外，有时从设计上我们会对请求进行异步化处理。此时，我们需要搭建后台任务相关基础设施。Spring原生提供了任务处理(TaskExecutor)和任务计划(TaskSchedulor)机制；而在分布式场景下，还需要引入<a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Distributed_lock_manager" >分布式锁<i class="fas fa-external-link-alt"></i></a>来解决并发冲突，为此我们引入一个轻量级的分布式锁框架<a class="link"   target="_blank" rel="noopener" href="https://github.com/lukas-krecan/ShedLock" >ShedLock<i class="fas fa-external-link-alt"></i></a>。</p>
<p>启用Spring任务配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulingConfiguration</span> <span class="keyword">implements</span> <span class="title">SchedulingConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureTasks</span><span class="params">(ScheduledTaskRegistrar taskRegistrar)</span> </span>&#123;</span><br><span class="line">        taskRegistrar.setScheduler(newScheduledThreadPool(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(destroyMethod = &quot;shutdown&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TaskExecutor <span class="title">taskExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">2</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">5</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">10</span>);</span><br><span class="line">        executor.setTaskDecorator(<span class="keyword">new</span> LogbackMdcTaskDecorator());</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后配置Shedlock：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSchedulerLock(defaultLockAtMostFor = &quot;PT30S&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedLockConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LockProvider <span class="title">lockProvider</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplateLockProvider(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DistributedLockExecutor <span class="title">distributedLockExecutor</span><span class="params">(LockProvider lockProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DistributedLockExecutor(lockProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现后台任务处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scheduled(cron = &quot;0 0/1 * * * ?&quot;)</span></span><br><span class="line"><span class="meta">@SchedulerLock(name = &quot;scheduledTask&quot;, lockAtMostFor = THIRTY_MIN, lockAtLeastFor = ONE_MIN)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">&quot;Run scheduled task.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了支持代码直接调用分布式锁，基于Shedlock的LockProvider创建DistributedLockExecutor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedLockExecutor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LockProvider lockProvider;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DistributedLockExecutor</span><span class="params">(LockProvider lockProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lockProvider = lockProvider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">executeWithLock</span><span class="params">(Supplier&lt;T&gt; supplier, LockConfiguration configuration)</span> </span>&#123;</span><br><span class="line">        Optional&lt;SimpleLock&gt; lock = lockProvider.lock(configuration);</span><br><span class="line">        <span class="keyword">if</span> (!lock.isPresent()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockAlreadyOccupiedException(configuration.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> supplier.get();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.get().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用时在代码中直接调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">doBusiness</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> distributedLockExecutor.executeWithLock(() -&gt; <span class="string">&quot;Hello World.&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> LockConfiguration(<span class="string">&quot;key&quot;</span>, Instant.now().plusSeconds(<span class="number">60</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本文的示例项目使用了基于JDBC的分布式锁，事实上任何提供原子操作的机制都可用于分布式锁，Shedlock还提供基于Redis、ZooKeeper和Hazelcast等的分布式锁实现机制。</p>
<h3 id="统一代码风格"><a href="#统一代码风格" class="headerlink" title="统一代码风格"></a>统一代码风格</h3><p>除了Checkstyle统一代码格式之外，项目中有些通用的公共的编码实践方式也需要在整个开发团队中进行统一，包括但不限于以下方面：</p>
<ul>
<li>客户端的请求数据类统一使用相同后缀，比如Command</li>
<li>返回给客户端的数据统一使用相同后缀，比如Represetation</li>
<li>统一对请求处理的流程框架，比如采用传统的3层架构或者DDD战术模式</li>
<li>提供一致的异常返回（请参考“异常处理”小节）</li>
<li>提供统一的分页结构类</li>
<li>明确测试分类以及统一的测试基础类（请参考“自动化测试分类”小节）</li>
</ul>
<h3 id="静态代码检查"><a href="#静态代码检查" class="headerlink" title="静态代码检查"></a>静态代码检查</h3><p>静态代码检查主要包含以下Gradle插件，具体配置请参考本文示例代码：</p>
<ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/checkstyle_plugin.html" >Checkstyle<i class="fas fa-external-link-alt"></i></a>：用于检查代码格式，规范编码风格</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://spotbugs.github.io/" >Spotbugs<i class="fas fa-external-link-alt"></i></a>：Findbugs的继承者</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://plugins.gradle.org/plugin/org.owasp.dependencycheck" >Dependency check<i class="fas fa-external-link-alt"></i></a>：<a class="link"   target="_blank" rel="noopener" href="https://www.owasp.org/index.php/OWASP_Dependency_Check" >OWASP<i class="fas fa-external-link-alt"></i></a>提供的Java类库安全性检查</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Sonar" >Sonar<i class="fas fa-external-link-alt"></i></a>：用于代码持续改进的跟踪</li>
</ul>
<h3 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h3><p>健康检查主要用于以下场景：</p>
<ul>
<li>我们希望初步检查程序是否运行正常</li>
<li>有些负载均衡软件会通过一个健康检查URL判断节点的可达性</li>
</ul>
<p>此时，可以实现一个简单的API接口，该接口不受权限管控，可以公开访问。如果该接口返回HTTP的200状态码，便可初步认为程序运行正常。此外，我们还可以在该API中加入一些额外的信息，比如提交版本号、构建时间、部署时间等。</p>
<p>启动本文的示例项目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./run.sh</span><br></pre></td></tr></table></figure>

<p>然后访问健康检查API：<a class="link"   target="_blank" rel="noopener" href="http://localhost:8080/about%EF%BC%8C%E7%BB%93%E6%9E%9C%E5%A6%82%E4%B8%8B%EF%BC%9A" >http://localhost:8080/about，结果如下：<i class="fas fa-external-link-alt"></i></a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  requestId: <span class="string">&quot;698c8d29add54e24a3d435e2c749ea00&quot;</span>,</span><br><span class="line">  buildNumber: <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">  buildTime: <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">  deployTime: <span class="string">&quot;2019-04-11T13:05:46.901+08:00[Asia/Shanghai]&quot;</span>,</span><br><span class="line">  gitRevision: <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">  gitBranch: <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">  environment: <span class="string">&quot;[local]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上接口在示例项目中用了一个简单的Controller实现，事实上Spring Boot<a class="link"   target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-boot/tree/master/spring-boot-project/spring-boot-actuator" >的Acuator<i class="fas fa-external-link-alt"></i></a>框架也能够提供相似的功能。</p>
<h3 id="API文档"><a href="#API文档" class="headerlink" title="API文档"></a>API文档</h3><p>软件文档的难点不在于写，而在于维护。多少次，当我对照着项目文档一步一步往下走时，总得不到正确的结果，问了同事之后得到回复“哦，那个已经过时了”。本文示例项目所采用的<a class="link"   target="_blank" rel="noopener" href="https://insights.thoughtworks.cn/backend-development-iteration0/[http://springfox.github.io/springfox/](http://springfox.github.io/springfox/)" >Swagger<i class="fas fa-external-link-alt"></i></a>在一定程度上降低了API维护的成本，因为Swagger能自动识别代码中的方法参数、返回对象和URL等信息，然后自动地实时地创建出API文档。</p>
<p>配置Swagger如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="meta">@Profile(value = &#123;&quot;local&quot;, &quot;dev&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">api</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(SWAGGER_2)</span><br><span class="line">                .select()</span><br><span class="line">                .apis(basePackage(<span class="string">&quot;com.ecommerce.order&quot;</span>))</span><br><span class="line">                .paths(any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动本地项目，访问<a class="link"   target="_blank" rel="noopener" href="http://localhost:8080/swagger-ui.html%EF%BC%9A" >http://localhost:8080/swagger-ui.html：<i class="fas fa-external-link-alt"></i></a></p>
<p><img src="http://pic.noddd.cn/posts/20201215210457.png" alt="api-documentation-1"></p>
<h3 id="数据库迁移"><a href="#数据库迁移" class="headerlink" title="数据库迁移"></a>数据库迁移</h3><p>在传统的开发模式中，数据库由专门的运维团队或者DBA来维护，要对数据库进行修改需要向DBA申请，告之迁移内容，最后由DBA负责数据库变更实施。在<a class="link"   target="_blank" rel="noopener" href="https://insights.thoughtworks.cn/backend-development-iteration0/[https://en.wikipedia.org/wiki/Continuous_delivery](https://en.wikipedia.org/wiki/Continuous_delivery)" >持续交付<i class="fas fa-external-link-alt"></i></a>和<a class="link"   target="_blank" rel="noopener" href="https://insights.thoughtworks.cn/backend-development-iteration0/[https://en.wikipedia.org/wiki/DevOps](https://en.wikipedia.org/wiki/DevOps)" >DevOps<i class="fas fa-external-link-alt"></i></a>运动中，这些工作逐步提前到开发过程，当然并不是说不需要DBA了，而是这些工作可以由开发者和运维人员一同完成。另外，在微服务场景下，数据库被包含在单个服务的边界之内，因此基于内聚性原则（咦，这好像是本文第三次提到内聚原则了，可见其在软件开发中的重要性），数据库的变更最好也与项目代码一道维护在代码库中。</p>
<p>本文的示例项目采用了Flyway作为数据库迁移工具，加入了<a class="link"   target="_blank" rel="noopener" href="https://flywaydb.org/" >Flyway<i class="fas fa-external-link-alt"></i></a>依赖后，在<code>src/main/sources/db/migration</code>目录下创建迁移脚本文件即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">resources/</span><br><span class="line">├── db</span><br><span class="line">│   └── migration</span><br><span class="line">│       ├── V1__init.sql</span><br><span class="line">│       └── V2__create_product_table.sql</span><br></pre></td></tr></table></figure>

<p>迁移脚本的命名需要遵循一定的<a class="link"   target="_blank" rel="noopener" href="https://flywaydb.org/documentation/migrations#syntax" >规则<i class="fas fa-external-link-alt"></i></a>以保证脚本执行顺序，另外迁移文件生效之后不要任意修改，因为Flyway会检查文件的checksum，如果checksum不一致将导致迁移失败。</p>
<h3 id="多环境构建"><a href="#多环境构建" class="headerlink" title="多环境构建"></a>多环境构建</h3><p>在软件的开发流程中，我们需要将软件部署到多个环境，经过多轮验证后才能最终上线。在不同的阶段中，软件的运行态可能是不一样的，比如本地开发时可能将所依赖的第三方系统stub掉；持续集成构建时可能使用的是测试用的内存数据库等等。为此，本文的示例项目推荐采用以下环境：</p>
<ul>
<li>local：用于开发者本地开发</li>
<li>ci：用于持续集成</li>
<li>dev：用于前端开发联调</li>
<li>qa：用于测试人员</li>
<li>uat：类生产环境，用于功能验收(有时也称为staging环境)</li>
<li>prod：正式的生产环境</li>
</ul>
<h3 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h3><p>在前后端分离的系统中，前端单独部署，有时连域名都和后端不同，此时需要进行跨域处理。传统的做法可以通过JSONP，但这是一种比较“trick”的做法，当前更通用的实践是采用<a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing" >CORS<i class="fas fa-external-link-alt"></i></a>机制，在Spring Boot项目中，启用CORS配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebMvcConfigurer <span class="title">corsConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">                registry.addMapping(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于使用Spring Security的项目，需要保证CORS工作于Spring Security的过滤器之前，为此Spring Security专门提供了相应配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">            <span class="comment">// by default uses a Bean by the name of corsConfigurationSource</span></span><br><span class="line">            .cors().and()</span><br><span class="line">            ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">CorsConfigurationSource <span class="title">corsConfigurationSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CorsConfiguration configuration = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">        configuration.setAllowedOrigins(Arrays.asList(<span class="string">&quot;https://example.com&quot;</span>));</span><br><span class="line">        configuration.setAllowedMethods(Arrays.asList(<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>));</span><br><span class="line">        UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, configuration);</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="常用第三方类库"><a href="#常用第三方类库" class="headerlink" title="常用第三方类库"></a>常用第三方类库</h3><p>这里列出一些比较常见的第三方库，开发者们可以根据项目所需引入：</p>
<ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Guava" >Guava<i class="fas fa-external-link-alt"></i></a>：来自Google的常用类库</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://commons.apache.org/" >Apache Commons<i class="fas fa-external-link-alt"></i></a>：来自Apache的常用类库</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://site.mockito.org/" >Mockito<i class="fas fa-external-link-alt"></i></a>：主要用于单元测试的mock</li>
<li><a class="link"   target="_blank" rel="noopener" href="http://dbunit.sourceforge.net/" >DBUnit<i class="fas fa-external-link-alt"></i></a>：测试中管理数据库测试数据</li>
<li><a class="link"   target="_blank" rel="noopener" href="http://rest-assured.io/" >RestAssured<i class="fas fa-external-link-alt"></i></a>：用于Rest API测试</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://www.mkyong.com/java/jackson-2-convert-java-object-to-from-json/" >Jackson 2<i class="fas fa-external-link-alt"></i></a>：Json数据的序列化和反序列化</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://jwt.io/" >jjwt<i class="fas fa-external-link-alt"></i></a>：Jwt token认证</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://projectlombok.org/" >Lombok<i class="fas fa-external-link-alt"></i></a>：自动生成常用Java代码，比如equals()方法等；</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign" >Feign<i class="fas fa-external-link-alt"></i></a>：声明式Rest客户端</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://tika.apache.org/" >Tika<i class="fas fa-external-link-alt"></i></a>：用于准确检测文件类型</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://itextpdf.com/en" >itext<i class="fas fa-external-link-alt"></i></a>：生成Pdf文件等</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://github.com/zxing/zxing" >zxing<i class="fas fa-external-link-alt"></i></a>：生成二维码</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://x-stream.github.io/" >Xstream<i class="fas fa-external-link-alt"></i></a>：比Jaxb更轻量级的XML处理库</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文通过一个示例项目谈及到了项目之初开发者搭建后端工程的诸多方面，其中的绝大多数实践均在笔者的项目中真实落地。读完本文之后你可能会发现，文中的很多内容都是很基础很简单的。没错，的确没有什么难的东西，但是要系统性地搭建好后端项目的基础框架却不见得是每个开发团队都已经做到的事情，而这恰恰是本文的目的。最后，需要提醒的是，本文提到的实践方式只是一个参考，一方面依然存在考虑不周的地方，另一方面示例项目中用到的技术工具还存在其他替代方案，请根据自己项目的实际情况进行取舍。</p>
<blockquote>
<p>原文链接：<a class="link"   target="_blank" rel="noopener" href="https://insights.thoughtworks.cn/backend-development-iteration0/" >https://insights.thoughtworks.cn/backend-development-iteration0/<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>

        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/posts/2ef1ee70-3ed7-11eb-94de-113554c55770/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">后端开发实践系列——领域驱动设计(DDD)编码实践</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/posts/4da5a010-2e55-11eb-b4a4-03f48a66ad92/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">你真的知道怎么实现一个延迟队列吗？</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>&nbsp;-&nbsp;
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">ZhenYu</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
            <div class="icp-info info-item"><a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn">京ICP备18000555号-4</a></div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%BB%8E%E5%86%99%E5%A5%BDREADME%E5%BC%80%E5%A7%8B"><span class="nav-number">1.</span> <span class="nav-text">第一步：从写好README开始</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E9%94%AE%E5%BC%8F%E6%9C%AC%E5%9C%B0%E6%9E%84%E5%BB%BA"><span class="nav-number">2.</span> <span class="nav-text">一键式本地构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">3.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E4%B8%9A%E5%8A%A1%E5%88%86%E5%8C%85"><span class="nav-number">4.</span> <span class="nav-text">基于业务分包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E5%88%86%E7%B1%BB"><span class="nav-number">5.</span> <span class="nav-text">自动化测试分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">日志处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">7.</span> <span class="nav-text">异常处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="nav-number">8.</span> <span class="nav-text">后台任务与分布式锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%9F%E4%B8%80%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC"><span class="nav-number">9.</span> <span class="nav-text">统一代码风格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5"><span class="nav-number">10.</span> <span class="nav-text">静态代码检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="nav-number">11.</span> <span class="nav-text">健康检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API%E6%96%87%E6%A1%A3"><span class="nav-number">12.</span> <span class="nav-text">API文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB"><span class="nav-number">13.</span> <span class="nav-text">数据库迁移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E6%9E%84%E5%BB%BA"><span class="nav-number">14.</span> <span class="nav-text">多环境构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CORS"><span class="nav-number">15.</span> <span class="nav-text">CORS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E7%B1%BB%E5%BA%93"><span class="nav-number">16.</span> <span class="nav-text">常用第三方类库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">17.</span> <span class="nav-text">总结</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>








<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
