<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="ZhenYu">
    
    <title>
        
            阿里技术专家详解DDD系列 第一弹 - DomainPrimitive |
        
        NoDDD
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"noddd.cn","root":"/","language":"zh-CN"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                NoDDD
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags/go"
                            >
                                GO
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags/DDD/"
                            >
                                DDD
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags/go">GO</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags/DDD/">DDD</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">阿里技术专家详解DDD系列 第一弹 - DomainPrimitive</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">ZhenYu</span>
                        
                            <span class="author-label">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2020-06-05 19:04:45
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/DDD/">DDD</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E9%98%BF%E9%87%8C%E6%8A%80%E6%9C%AF%E4%B8%93%E5%AE%B6%E8%AF%A6%E8%A7%A3DDD/">阿里技术专家详解DDD</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>7k 字</span>
        </span>
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <blockquote>
<p>原文出处：</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/tTnj4XHy-Q0S_25VO9F7gQ" >https://mp.weixin.qq.com/s/tTnj4XHy-Q0S_25VO9F7gQ<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<hr>
<blockquote>
<p>导读：对于一个架构师来说，在软件开发中如何降低系统复杂度是一个永恒的挑战，无论是 94 年 GoF 的 Design Patterns ， 99 年的 Martin Fowler 的 Refactoring ， 02 年的 P of EAA ，还是 03 年的 Enterprise Integration Patterns ，都是通过一系列的设计模式或范例来降低一些常见的复杂度。但是问题在于，这些书的理念是通过技术手段解决技术问题，但并没有从根本上解决业务的问题。所以 03 年 Eric Evans 的 Domain Driven Design 一书，以及后续 Vaughn Vernon 的 Implementing DDD ， Uncle Bob 的 Clean Architecture 等书，真正的从业务的角度出发，为全世界绝大部分做纯业务的开发提供了一整套的架构思路。</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于 DDD 不是一套框架，而是一种架构思想，所以在代码层面缺乏了足够的约束，导致 DDD 在实际应用中上手门槛很高，甚至可以说绝大部分人都对 DDD 的理解有所偏差。举个例子， Martin Fowler 在他个人博客里描述的一个 Anti-pattern，Anemic Domain Model ①（贫血域模型）在实际应用当中层出不穷，而一些仍然火热的 ORM 工具比如 Hibernate，Entity Framework 实际上助长了贫血模型的扩散。同样的，传统的基于数据库技术以及 MVC 的四层应用架构（UI、Business、Data Access、Database），在一定程度上和 DDD 的一些概念混淆，导致绝大部分人在实际应用当中仅仅用到了 DDD 的建模的思想，而其对于整个架构体系的思想无法落地。</p>
<p>我第一次接触 DDD 应该是 2012 年，当时除了大型互联网公司，基本上商业应用都还处于单机的时代，服务化的架构还局限于单机 +LB 用 MVC 提供 Rest 接口供外部调用，或者用 SOAP 或 WebServices 做 RPC 调用，但其实更多局限于对外部依赖的协议。让我关注到 DDD 思想的是一个叫 Anti-Corruption Layer（防腐层）的概念，特别是其在解决外部依赖频繁变更的情况下，如何将核心业务逻辑和外部依赖隔离的机制。到了 2014 年， SOA 开始大行其道，微服务的概念开始冒头，而如何将一个 Monolith 应用合理的拆分为多个微服务成为了各大论坛的热门话题，而 DDD 里面的 Bounded Context（限界上下文）的思想为微服务拆分提供了一套合理的框架。而在今天，在一个所有的东西都能被称之为“服务”的时代（XAAS）， DDD 的思想让我们能冷静下来，去思考到底哪些东西可以被服务化拆分，哪些逻辑需要聚合，才能带来最小的维护成本，而不是简单的去追求开发效率。</p>
<p>所以今天，我开始这个关于 DDD 的一系列文章，希望能继续在总结前人的基础上发扬光大 DDD 的思想，但是通过一套我认为合理的代码结构、框架和约束，来降低 DDD 的实践门槛，提升代码质量、可测试性、安全性、健壮性。</p>
<p>未来会覆盖的内容包括：</p>
<ul>
<li>最佳架构实践：六边形应用架构 / Clean 架构的核心思想和落地方案</li>
<li>持续发现和交付：Event Storming &gt; Context Map &gt; Design Heuristics &gt; Modelling</li>
<li>降低架构腐败速度：通过 Anti-Corruption Layer 集成第三方库的模块化方案</li>
<li>标准组件的规范和边界：Entity, Aggregate, Repository, Domain Service, Application Service,Event, DTO Assembler 等</li>
<li>基于 Use Case 重定义应用服务的边界</li>
<li>基于 DDD 的微服务化改造及颗粒度控制</li>
<li>CQRS 架构的改造和挑战</li>
<li>基于事件驱动的架构的挑战</li>
<li>等等</li>
</ul>
<p>今天先给大家带来一篇最基础，但极其有价值的Domain Primitive的概念。</p>
<h2 id="Domain-Primitive"><a href="#Domain-Primitive" class="headerlink" title="Domain Primitive"></a>Domain Primitive</h2><p>就好像在学任何语言时首先需要了解的是基础数据类型一样，在全面了解 DDD 之前，首先给大家介绍一个最基础的概念: Domain Primitive（DP）。</p>
<p>Primitive 的定义是：</p>
<blockquote>
<p>不从任何其他事物发展而来</p>
<p>初级的形成或生长的早期阶段</p>
</blockquote>
<p>就好像 Integer、String 是所有编程语言的Primitive一样，在 DDD 里， DP 可以说是一切模型、方法、架构的基础，而就像 Integer、String 一样， DP 又是无所不在的。所以，第一讲会对 DP 做一个全面的介绍和分析，但我们先不去讲概念，而是从案例入手，看看为什么 DP 是一个强大的概念。</p>
<h3 id="1案例分析"><a href="#1案例分析" class="headerlink" title="1案例分析"></a>1案例分析</h3><p>我们先看一个简单的例子，这个 case 的业务逻辑如下：</p>
<blockquote>
<p>一个新应用在全国通过 地推业务员 做推广，需要做一个用户注册系统，同时希望在用户注册后能够通过用户电话（先假设仅限座机）的地域（区号）对业务员发奖金。</p>
</blockquote>
<p>先不要去纠结这个根据用户电话去发奖金的业务逻辑是否合理，也先不要去管用户是否应该在注册时和业务员做绑定，这里我们看的主要还是如何更加合理的去实现这个逻辑。一个简单的用户和用户注册的代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    Long userId;</span><br><span class="line">    String name;</span><br><span class="line">    String phone;</span><br><span class="line">    String address;</span><br><span class="line">    Long repId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistrationServiceImpl</span> <span class="keyword">implements</span> <span class="title">RegistrationService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SalesRepRepository salesRepRepo;</span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">register</span><span class="params">(String name, String phone, String address)</span> </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ValidationException </span>&#123;</span><br><span class="line">        <span class="comment">// 校验逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (phone == <span class="keyword">null</span> || !isValidPhoneNumber(phone)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;phone&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 此处省略address的校验逻辑</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取电话号里的区号，然后通过区号找到区域内的SalesRep</span></span><br><span class="line">        String areaCode = <span class="keyword">null</span>;</span><br><span class="line">        String[] areas = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;0571&quot;</span>, <span class="string">&quot;021&quot;</span>, <span class="string">&quot;010&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; phone.length(); i++) &#123;</span><br><span class="line">            String prefix = phone.substring(<span class="number">0</span>, i);</span><br><span class="line">            <span class="keyword">if</span> (Arrays.asList(areas).contains(prefix)) &#123;</span><br><span class="line">                areaCode = prefix;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        SalesRep rep = salesRepRepo.findRep(areaCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后创建用户，落盘，然后返回</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.name = name;</span><br><span class="line">        user.phone = phone;</span><br><span class="line">        user.address = address;</span><br><span class="line">        <span class="keyword">if</span> (rep != <span class="keyword">null</span>) &#123;</span><br><span class="line">            user.repId = rep.repId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userRepo.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isValidPhoneNumber</span><span class="params">(String phone)</span> </span>&#123;</span><br><span class="line">        String pattern = <span class="string">&quot;^0[1-9]&#123;2,3&#125;-?\\d&#123;8&#125;$&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> phone.matches(pattern);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们日常绝大部分代码和模型其实都跟这个是类似的，乍一看貌似没啥问题，但我们再深入一步，从以下四个维度去分析一下：<strong>接口的清晰度（可阅读性）、数据验证和错误处理、业务逻辑代码的清晰度、和可测试性</strong>。</p>
<ol>
<li><strong>问题1：接口的清晰度</strong></li>
</ol>
<p>在Java代码中，对于一个方法来说所有的参数名在编译时丢失，留下的仅仅是一个参数类型的列表，所以我们重新看一下以上的接口定义，其实在运行时仅仅是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">User <span class="title">register</span><span class="params">(String, String, String)</span></span>;</span><br></pre></td></tr></table></figure>

<p>所以以下的代码是一段编译器完全不会报错的，很难通过看代码就能发现的 bug ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.register(<span class="string">&quot;殷浩&quot;</span>, <span class="string">&quot;浙江省杭州市余杭区文三西路969号&quot;</span>, <span class="string">&quot;0571-12345678&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>当然，在真实代码中运行时会报错，但这种 bug 是在运行时被发现的，而不是在编译时。普通的 Code Review 也很难发现这种问题，很有可能是代码上线后才会被暴露出来。这里的思考是，<strong>有没有办法在编码时就避免这种可能会出现的问题</strong>？</p>
<p>另外一种常见的，特别是在查询服务中容易出现的例子如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">User <span class="title">findByName</span><span class="params">(String name)</span></span>;</span><br><span class="line"><span class="function">User <span class="title">findByPhone</span><span class="params">(String phone)</span></span>;</span><br><span class="line"><span class="function">User <span class="title">findByNameAndPhone</span><span class="params">(String name, String phone)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在这个场景下，由于入参都是 String 类型，不得不在方法名上面加上 <code>ByXXX </code>来区分，而 <code>findByNameAndPhone </code>同样也会陷入前面的入参顺序错误的问题，而且和前面的入参不同，这里参数顺序如果输错了，方法不会报错只会返回 <code>null</code>，而这种 bug 更加难被发现。这里的思考是，<strong>有没有办法让方法入参一目了然，避免入参错误导致的 bug</strong> ？</p>
<ol start="2">
<li><strong>问题2 - 数据验证和错误处理</strong></li>
</ol>
<p>在前面这段数据校验代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (phone == <span class="keyword">null</span> || !isValidPhoneNumber(phone)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;phone&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在日常编码中经常会出现，一般来说这种代码需要出现在方法的最前端，确保能够 fail-fast 。但是假设你有多个类似的接口和类似的入参，在每个方法里这段逻辑会被重复。而更严重的是如果未来我们要拓展电话号去包含手机时，很可能需要加入以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (phone == <span class="keyword">null</span> || !isValidPhoneNumber(phone) || !isValidCellNumber(phone)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;phone&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你有很多个地方用到了 phone 这个入参，但是有个地方忘记修改了，会造成 bug 。这是一个 DRY 原则被违背时经常会发生的问题。</p>
<p>如果有个新的需求，需要把入参错误的原因返回，那么这段代码就变得更加复杂：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (phone == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;phone不能为空&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isValidPhoneNumber(phone)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;phone格式错误&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以想像得到，代码里充斥着大量的类似代码块时，维护成本要有多高。</p>
<p>最后，在这个业务方法里，会（隐性或显性的）抛 <code>ValidationException</code>，所以需要外部调用方去try/catch，而<strong>业务逻辑异常和数据校验异常被混在了一起，是否是合理的</strong>？</p>
<p>在传统Java架构里有几个办法能够去解决一部分问题，常见的如BeanValidation注解或ValidationUtils类，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use Bean Validation</span></span><br><span class="line"><span class="function">User <span class="title">registerWithBeanValidation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="meta">@NotNull</span> <span class="meta">@NotBlank</span> String name,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="meta">@NotNull</span> <span class="meta">@Pattern(regexp = &quot;^0?[1-9]&#123;2,3&#125;-?\\d&#123;8&#125;$&quot;)</span> String phone,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="meta">@NotNull</span> String address</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use ValidationUtils:</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">registerWithUtils</span><span class="params">(String name, String phone, String address)</span> </span>&#123;</span><br><span class="line">    ValidationUtils.validateName(name); <span class="comment">// throws ValidationException</span></span><br><span class="line">    ValidationUtils.validatePhone(phone);</span><br><span class="line">    ValidationUtils.validateAddress(address);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但这几个传统的方法同样有问题，</p>
<p><strong>BeanValidation：</strong></p>
<ul>
<li>通常只能解决简单的校验逻辑，复杂的校验逻辑一样要写代码实现定制校验器</li>
<li>在添加了新校验逻辑时，同样会出现在某些地方忘记添加一个注解的情况，DRY原则还是会被违背</li>
</ul>
<p><strong>ValidationUtils类：</strong></p>
<ul>
<li>当大量的校验逻辑集中在一个类里之后，违背了Single Responsibility单一性原则，导致代码混乱和不可维护</li>
<li>业务异常和校验异常还是会混杂</li>
</ul>
<p>所以，有没有一种方法，能够一劳永逸的解决所有校验的问题以及降低后续的维护成本和异常处理成本呢？</p>
<ol start="3">
<li><strong>问题3 - 业务代码的清晰度</strong></li>
</ol>
<p>在这段代码里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">String areaCode = <span class="keyword">null</span>;</span><br><span class="line">String[] areas = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;0571&quot;</span>, <span class="string">&quot;021&quot;</span>, <span class="string">&quot;010&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; phone.length(); i++) &#123;</span><br><span class="line">    String prefix = phone.substring(<span class="number">0</span>, i);</span><br><span class="line">    <span class="keyword">if</span> (Arrays.asList(areas).contains(prefix)) &#123;</span><br><span class="line">        areaCode = prefix;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">SalesRep rep = salesRepRepo.findRep(areaCode);</span><br></pre></td></tr></table></figure>

<p>实际上出现了另外一种常见的情况，那就是从一些入参里抽取一部分数据，然后调用一个外部依赖获取更多的数据，然后通常从新的数据中再抽取部分数据用作其他的作用。这种代码通常被称作“胶水代码”，其本质是由于外部依赖的服务的入参并不符合我们原始的入参导致的。比如，如果<code>SalesRepRepository</code>包含一个<code>findRepByPhone</code>的方法，则上面大部分的代码都不必要了。</p>
<p>所以，一个常见的办法是将这段代码抽离出来，变成独立的一个或多个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">findAreaCode</span><span class="params">(String phone)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; phone.length(); i++) &#123;</span><br><span class="line">        String prefix = phone.substring(<span class="number">0</span>, i);</span><br><span class="line">        <span class="keyword">if</span> (isAreaCode(prefix)) &#123;</span><br><span class="line">            <span class="keyword">return</span> prefix;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAreaCode</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">    String[] areas = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;0571&quot;</span>, <span class="string">&quot;021&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(areas).contains(prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后原始代码变为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String areaCode = findAreaCode(phone);</span><br><span class="line">SalesRep rep = salesRepRepo.findRep(areaCode);</span><br></pre></td></tr></table></figure>

<p>而为了复用以上的方法，可能会抽离出一个静态工具类 <code>PhoneUtils </code>。但是这里要思考的是，静态工具类是否是最好的实现方式呢？当你的项目里充斥着大量的静态工具类，业务代码散在多个文件当中时，你是否还能找到核心的业务逻辑呢？</p>
<ol start="4">
<li><strong>问题4 - 可测试性</strong></li>
</ol>
<p>为了保证代码质量，每个方法里的每个入参的每个可能出现的条件都要有 TC 覆盖（假设我们先不去测试内部业务逻辑），所以在我们这个方法里需要以下的 TC ：</p>
<p><img src="http://pic.noddd.cn/posts/20200605160818.png" alt="9099614d1b71c0f3fe3702c632c10466"></p>
<p>假如一个方法有 N 个参数，每个参数有 M 个校验逻辑，至少要有 N * M 个 TC  。</p>
<p>如果这时候在该方法中加入一个新的入参字段 <code>fax </code>，即使 <code>fax </code>和 <code>phone </code>的校验逻辑完全一致，为了保证 TC 覆盖率，也一样需要 M 个新的 TC 。</p>
<p>而假设有 P 个方法中都用到了 <code>phone </code>这个字段，这 P 个方法都需要对该字段进行测试，也就是说整体需要：</p>
<p> <strong>P * N * M</strong> </p>
<p>个测试用例才能完全覆盖所有数据验证的问题，在日常项目中，这个测试的成本非常之高，导致大量的代码没被覆盖到。而没被测试覆盖到的代码才是最有可能出现问题的地方。</p>
<p>在这个情况下，降低测试成本 == 提升代码质量，如何能够降低测试的成本呢？</p>
<h3 id="2解决方案"><a href="#2解决方案" class="headerlink" title="2解决方案"></a>2解决方案</h3><p>我们回头先重新看一下原始的 use case，并且标注其中可能重要的概念：</p>
<blockquote>
<p>一个新应用在全国通过 地推业务员 做推广，需要做一个用户的注册系统，在用户注册后能够通过用户电话号的区号对业务员发奖金。</p>
</blockquote>
<p>在分析了 use case 后，发现其中地推业务员、用户本身自带 ID 属性，属于 Entity（实体），而注册系统属于 Application Service（应用服务），这几个概念已经有存在。但是发现电话号这个概念却完全被隐藏到了代码之中。我们可以问一下自己，取电话号的区号的逻辑是否属于用户（用户的区号？）？是否属于注册服务（注册的区号？）？如果都不是很贴切，那就说明这个逻辑应该属于一个独立的概念。所以这里引入我们第一个原则：</p>
<p><strong>Make Implicit Concepts Explicit</strong></p>
<p><strong>将隐性的概念显性化</strong></p>
<p>在这里，我们可以看到，原来电话号仅仅是用户的一个参数，属于隐形概念，但实际上电话号的区号才是真正的业务逻辑，而我们需要将电话号的概念显性化，通过写一个Value Object：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneNumber</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String number;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PhoneNumber</span><span class="params">(String number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (number == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;number不能为空&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isValid(number)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;number格式错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAreaCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; number.length(); i++) &#123;</span><br><span class="line">            String prefix = number.substring(<span class="number">0</span>, i);</span><br><span class="line">            <span class="keyword">if</span> (isAreaCode(prefix)) &#123;</span><br><span class="line">                <span class="keyword">return</span> prefix;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAreaCode</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">        String[] areas = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;0571&quot;</span>, <span class="string">&quot;021&quot;</span>, <span class="string">&quot;010&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(areas).contains(prefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String number)</span> </span>&#123;</span><br><span class="line">        String pattern = <span class="string">&quot;^0?[1-9]&#123;2,3&#125;-?\\d&#123;8&#125;$&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> number.matches(pattern);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里面有几个很重要的元素：</p>
<ol>
<li>通过 <code>private final String number</code>  确保 <code>PhoneNumber </code>是一个（Immutable）Value Object。（一般来说 VO 都是 Immutable 的，这里只是重点强调一下）</li>
<li>校验逻辑都放在了 constructor 里面，确保只要 <code>PhoneNumber </code>类被创建出来后，一定是校验通过的。</li>
<li>之前的 <code>findAreaCode </code>方法变成了 <code>PhoneNumber </code>类里的 <code>getAreaCode </code>，突出了 <code>areaCode </code>是 <code>PhoneNumber </code>的一个计算属性。</li>
</ol>
<p>这样做完之后，我们发现把 <code>PhoneNumber </code>显性化之后，其实是生成了一个 Type（数据类型）和一个 Class（类）：</p>
<ul>
<li>Type 指我们在今后的代码里可以通过 <code>PhoneNumber </code>去显性的标识电话号这个概念</li>
<li>Class 指我们可以把所有跟电话号相关的逻辑完整的收集到一个文件里</li>
</ul>
<p>这两个概念加起来，构造成了本文标题的 Domain Primitive（DP）。</p>
<p>我们看一下全面使用了 DP 之后效果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    UserId userId;</span><br><span class="line">    Name name;</span><br><span class="line">    PhoneNumber phone;</span><br><span class="line">    Address address;</span><br><span class="line">    RepId repId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">register</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="meta">@NotNull</span> Name name,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="meta">@NotNull</span> PhoneNumber phone,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="meta">@NotNull</span> Address address</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 找到区域内的SalesRep</span></span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(phone.getAreaCode());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后创建用户，落盘，然后返回，这部分代码实际上也能用Builder解决</span></span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.name = name;</span><br><span class="line">    user.phone = phone;</span><br><span class="line">    user.address = address;</span><br><span class="line">    <span class="keyword">if</span> (rep != <span class="keyword">null</span>) &#123;</span><br><span class="line">        user.repId = rep.repId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> userRepo.saveUser(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到在使用了 DP 之后，所有的数据验证逻辑和非业务流程的逻辑都消失了，剩下都是核心业务逻辑，可以一目了然。我们重新用上面的四个维度评估一下：</p>
<ol>
<li><strong>评估1 - 接口的清晰度</strong></li>
</ol>
<p>重构后的方法签名变成了很清晰的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">register</span><span class="params">(Name, PhoneNumber, Address)</span></span></span><br></pre></td></tr></table></figure>

<p>而之前容易出现的bug，如果按照现在的写法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service.register(<span class="keyword">new</span> Name(<span class="string">&quot;殷浩&quot;</span>), <span class="keyword">new</span> Address(<span class="string">&quot;浙江省杭州市余杭区文三西路969号&quot;</span>), <span class="keyword">new</span> PhoneNumber(<span class="string">&quot;0571-12345678&quot;</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>让接口 API 变得很干净，易拓展。</p>
<ol start="2">
<li><strong>评估2 - 数据验证和错误处理</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">register</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="meta">@NotNull</span> Name name,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="meta">@NotNull</span> PhoneNumber phone,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="meta">@NotNull</span> Address address</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="comment">// no throws</span></span></span><br></pre></td></tr></table></figure>

<p>如前文代码展示的，重构后的方法里，完全没有了任何数据验证的逻辑，也不会抛 <code>ValidationException </code>。原因是因为 DP 的特性，只要是能够带到入参里的一定是正确的或 null（Bean Validation 或 lombok 的注解能解决 null 的问题）。所以我们把数据验证的工作量前置到了调用方，而调用方本来就是应该提供合法数据的，所以更加合适。</p>
<p>再展开来看，使用DP的另一个好处就是代码遵循了 DRY 原则和单一性原则，如果未来需要修改 <code>PhoneNumber </code>的校验逻辑，只需要在一个文件里修改即可，所有使用到了 <code>PhoneNumber </code>的地方都会生效。</p>
<ol start="3">
<li><strong>评估3 - 业务代码的清晰度</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SalesRep rep = salesRepRepo.findRep(phone.getAreaCode());</span><br><span class="line">User user = xxx;</span><br><span class="line"><span class="keyword">return</span> userRepo.save(user);</span><br></pre></td></tr></table></figure>

<p>除了在业务方法里不需要校验数据之外，原来的一段胶水代码 <code>findAreaCode </code>被改为了 <code>PhoneNumber </code>类的一个计算属性 <code>getAreaCode </code>，让代码清晰度大大提升。而且胶水代码通常都不可复用，但是使用了 DP 后，变成了可复用、可测试的代码。我们能看到，在刨除了数据验证代码、胶水代码之后，剩下的都是核心业务逻辑。（ Entity 相关的重构在后面文章会谈到，这次先忽略）</p>
<ol start="4">
<li><strong>评估4 - 可测试性</strong></li>
</ol>
<p><img src="http://pic.noddd.cn/posts/20200605160832.png" alt="861991a262694319b825955210509928"></p>
<p>当我们将 <code>PhoneNumber </code>抽取出来之后，在来看测试的 TC ：</p>
<ul>
<li>首先 <code>PhoneNumber </code>本身还是需要 M 个测试用例，但是由于我们只需要测试单一对象，每个用例的代码量会大大降低，维护成本降低。</li>
<li>每个方法里的每个参数，现在只需要覆盖为 null 的情况就可以了，其他的 case 不可能发生（因为只要不是 null 就一定是合法的）</li>
</ul>
<p>所以，单个方法的 TC 从原来的 N * M 变成了今天的 N + M 。同样的，多个方法的 TC 数量变成了 </p>
<p>N + M + P</p>
<p>这个数量一般来说要远低于原来的数量 N* M * P ，让测试成本极大的降低。</p>
<ol start="5">
<li><strong>评估总结</strong></li>
</ol>
<p><img src="http://pic.noddd.cn/posts/20200605190258.png" alt="43b4747b571a4ded3550c6f3b11d3b43"></p>
<h3 id="进阶使用"><a href="#进阶使用" class="headerlink" title="进阶使用"></a>进阶使用</h3><p>在上文我介绍了 DP 的第一个原则：将隐性的概念显性化。在这里我将介绍 DP 的另外两个原则，用一个新的案例。</p>
<ol>
<li><strong>案例1 - 转账</strong></li>
</ol>
<p>假设现在要实现一个功能，让A用户可以支付 x 元给用户 B ，可能的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(BigDecimal money, Long recipientId)</span> </span>&#123;</span><br><span class="line">    BankService.transfer(money, <span class="string">&quot;CNY&quot;</span>, recipientId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果这个是境内转账，并且境内的货币永远不变，该方法貌似没啥问题，但如果有一天货币变更了（比如欧元区曾经出现的问题），或者我们需要做跨境转账，该方法是明显的 bug ，因为 <code>money </code>对应的货币不一定是 CNY 。</p>
<p>在这个 case 里，当我们说“支付 x 元”时，除了 x 本身的数字之外，实际上是有一个隐含的概念那就是货币“元”。但是在原始的入参里，之所以只用了 <code>BigDecimal </code>的原因是我们认为 CNY 货币是默认的，是一个隐含的条件，但是在我们写代码时，需要把所有隐性的条件显性化，而这些条件整体组成当前的上下文。所以 DP 的第二个原则是：</p>
<p><strong>Make Implicit Context Explicit</strong></p>
<p><strong>将 隐性的 上下文 显性化</strong></p>
<p>所以当我们做这个支付功能时，实际上需要的一个入参是支付金额 + 支付货币。我们可以把这两个概念组合成为一个独立的完整概念：<code>Money</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Money</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;</span><br><span class="line">    <span class="keyword">private</span> Currency currency;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Money</span><span class="params">(BigDecimal amount, Currency currency)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">        <span class="keyword">this</span>.currency = currency;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而原有的代码则变为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(Money money, Long recipientId)</span> </span>&#123;</span><br><span class="line">    BankService.transfer(money, recipientId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过将默认货币这个隐性的上下文概念显性化，并且和金额合并为 <code>Money </code>，我们可以避免很多当前看不出来，但未来可能会暴雷的bug。</p>
<ol start="2">
<li><strong>案例2 - 跨境转账</strong></li>
</ol>
<p>前面的案例升级一下，假设用户可能要做跨境转账从 CNY 到 USD ，并且货币汇率随时在波动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(Money money, Currency targetCurrency, Long recipientId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (money.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">        BankService.transfer(money, recipientId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        BigDecimal rate = ExchangeService.getRate(money.getCurrency(), targetCurrency);</span><br><span class="line">        BigDecimal targetAmount = money.getAmount().multiply(<span class="keyword">new</span> BigDecimal(rate));</span><br><span class="line">        Money targetMoney = <span class="keyword">new</span> Money(targetAmount, targetCurrency);</span><br><span class="line">        BankService.transfer(targetMoney, recipientId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个case里，由于 <code>targetCurrency </code>不一定和 <code>money </code>的 <code>Curreny </code>一致，需要调用一个服务去取汇率，然后做计算。最后用计算后的结果做转账。</p>
<p>这个case最大的问题在于，金额的计算被包含在了支付的服务中，涉及到的对象也有2个 <code>Currency </code>，2 个 <code>Money </code>，1 个 <code>BigDecimal </code>，总共 5 个对象。这种涉及到多个对象的业务逻辑，需要用 DP 包装掉，所以这里引出 DP 的第三个原则：</p>
<p><strong>Encapsulate Multi-Object Behavior</strong></p>
<p><strong>封装 多对象 行为</strong></p>
<p>在这个 case 里，可以将转换汇率的功能，封装到一个叫做 <code>ExchangeRate </code>的 DP 里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangeRate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal rate;</span><br><span class="line">    <span class="keyword">private</span> Currency from;</span><br><span class="line">    <span class="keyword">private</span> Currency to;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExchangeRate</span><span class="params">(BigDecimal rate, Currency from, Currency to)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rate = rate;</span><br><span class="line">        <span class="keyword">this</span>.from = from;</span><br><span class="line">        <span class="keyword">this</span>.to = to;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Money <span class="title">exchange</span><span class="params">(Money fromMoney)</span> </span>&#123;</span><br><span class="line">        notNull(fromMoney);</span><br><span class="line">        isTrue(<span class="keyword">this</span>.from.equals(fromMoney.getCurrency()));</span><br><span class="line">        BigDecimal targetAmount = fromMoney.getAmount().multiply(rate);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Money(targetAmount, to);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ExchangeRate </code>汇率对象，通过封装金额计算逻辑以及各种校验逻辑，让原始代码变得极其简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(Money money, Currency targetCurrency, Long recipientId)</span> </span>&#123;</span><br><span class="line">    ExchangeRate rate = ExchangeService.getRate(money.getCurrency(), targetCurrency);</span><br><span class="line">    Money targetMoney = rate.exchange(money);</span><br><span class="line">    BankService.transfer(targetMoney, recipientId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="讨论和总结"><a href="#讨论和总结" class="headerlink" title="讨论和总结"></a>讨论和总结</h3><ol>
<li><strong>Domain Primitive 的定义</strong></li>
</ol>
<p>让我们重新来定义一下 Domain Primitive ：Domain Primitive 是一个在特定领域里，拥有精准定义的、可自我验证的、拥有行为的 Value Object 。</p>
<ul>
<li>DP是一个传统意义上的Value Object，拥有Immutable的特性</li>
<li>DP是一个完整的概念整体，拥有精准定义</li>
<li>DP使用业务域中的原生语言</li>
<li>DP可以是业务域的最小组成部分、也可以构建复杂组合</li>
</ul>
<blockquote>
<p>注：Domain Primitive的概念和命名来自于Dan Bergh Johnsson &amp; Daniel Deogun的书 Secure by Design。</p>
</blockquote>
<ol start="2">
<li><strong>使用 Domain Primitive 的三原则</strong></li>
</ol>
<ul>
<li>让隐性的概念显性化</li>
<li>让隐性的上下文显性化</li>
<li>封装多对象行为</li>
</ul>
<ol start="3">
<li><strong>Domain Primitive 和 DDD 里 Value Object 的区别</strong></li>
</ol>
<p>在 DDD 中， Value Object 这个概念其实已经存在：</p>
<ul>
<li>在 Evans 的 DDD 蓝皮书中，Value Object 更多的是一个非 Entity 的值对象</li>
<li>在Vernon的IDDD红皮书中，作者更多的关注了Value Object的Immutability、Equals方法、Factory方法等</li>
</ul>
<p>Domain Primitive 是 Value Object 的进阶版，在原始 VO 的基础上要求每个 DP 拥有概念的整体，而不仅仅是值对象。在 VO 的 Immutable 基础上增加了 Validity 和行为。当然同样的要求无副作用（side-effect free）。</p>
<ol start="4">
<li><strong>Domain Primitive 和 Data Transfer Object (DTO) 的区别</strong></li>
</ol>
<p>在日常开发中经常会碰到的另一个数据结构是 DTO ，比如方法的入参和出参。DP 和 DTO 的区别如下：</p>
<p><img src="http://pic.noddd.cn/posts/20200605160845.png" alt="3bf9f56125f1355859f2394f9e2c553c"></p>
<ol start="5">
<li><strong>什么情况下应该用 Domain Primitive</strong></li>
</ol>
<p>常见的 DP 的使用场景包括：</p>
<ul>
<li>有格式限制的 <code>String</code>：比如<code>Name</code>，<code>PhoneNumber</code>，<code>OrderNumber</code>，<code>ZipCode</code>，<code>Address</code>等</li>
<li>有限制的<code>Integer</code>：比如<code>OrderId</code>（&gt;0），<code>Percentage</code>（0-100%），<code>Quantity</code>（&gt;=0）等</li>
<li>可枚举的 <code>int </code>：比如 <code>Status</code>（一般不用Enum因为反序列化问题）</li>
<li><code>Double </code>或 <code>BigDecimal</code>：一般用到的 <code>Double </code>或 <code>BigDecimal </code>都是有业务含义的，比如 <code>Temperature</code>、<code>Money</code>、<code>Amount</code>、<code>ExchangeRate</code>、<code>Rating </code>等</li>
<li>复杂的数据结构：比如 <code>Map </code>等，尽量能把 <code>Map </code>的所有操作包装掉，仅暴露必要行为</li>
</ul>
<h3 id="实战-老应用重构的流程"><a href="#实战-老应用重构的流程" class="headerlink" title="实战 - 老应用重构的流程"></a>实战 - 老应用重构的流程</h3><p>在新应用中使用 DP 是比较简单的，但在老应用中使用 DP 是可以遵循以下流程按部就班的升级。在此用本文的第一个 case 为例。</p>
<ol>
<li><strong>第一步 - 创建 Domain Primitive，收集所有 DP 行为</strong></li>
</ol>
<p>在前文中，我们发现取电话号的区号这个是一个可以独立出来的、可以放入 PhoneNumber 这个 Class 的逻辑。类似的，在真实的项目中，以前散落在各个服务或工具类里面的代码，可以都抽出来放在 DP 里，成为 DP 自己的行为或属性。这里面的原则是：所有抽离出来的方法要做到无状态，比如原来是 static 的方法。如果原来的方法有状态变更，需要将改变状态的部分和不改状态的部分分离，然后将无状态的部分融入 DP 。因为 DP 本身不能带状态，所以一切需要改变状态的代码都不属于 DP 的范畴。</p>
<p>(代码参考 PhoneNumber 的代码，这里不再重复)</p>
<ol start="2">
<li><strong>第二步 - 替换数据校验和无状态逻辑</strong></li>
</ol>
<p>为了保障现有方法的兼容性，在第二步不会去修改接口的签名，而是通过代码替换原有的校验逻辑和跟 DP 相关的业务逻辑。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">register</span><span class="params">(String name, String phone, String address)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ValidationException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (phone == <span class="keyword">null</span> || !isValidPhoneNumber(phone)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;phone&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    String areaCode = <span class="keyword">null</span>;</span><br><span class="line">    String[] areas = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;0571&quot;</span>, <span class="string">&quot;021&quot;</span>, <span class="string">&quot;010&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; phone.length(); i++) &#123;</span><br><span class="line">        String prefix = phone.substring(<span class="number">0</span>, i);</span><br><span class="line">        <span class="keyword">if</span> (Arrays.asList(areas).contains(prefix)) &#123;</span><br><span class="line">            areaCode = prefix;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(areaCode);</span><br><span class="line">    <span class="comment">// 其他代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 DP 替换代码后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">register</span><span class="params">(String name, String phone, String address)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ValidationException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    Name _name = <span class="keyword">new</span> Name(name);</span><br><span class="line">    PhoneNumber _phone = <span class="keyword">new</span> PhoneNumber(phone);</span><br><span class="line">    Address _address = <span class="keyword">new</span> Address(address);</span><br><span class="line">    </span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(_phone.getAreaCode());</span><br><span class="line">    <span class="comment">// 其他代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 new PhoneNumber(phone) 这种代码，替代了原有的校验代码。</p>
<p>通过 _phone.getAreaCode() 替换了原有的无状态的业务逻辑。</p>
<ol start="3">
<li><strong>第三步 - 创建新接口</strong></li>
</ol>
<p>创建新接口，将DP的代码提升到接口参数层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">register</span><span class="params">(Name name, PhoneNumber phone, Address address)</span> </span>&#123;</span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(phone.getAreaCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>第四步 - 修改外部调用</strong></li>
</ol>
<p>外部调用方需要修改调用链路，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.register(<span class="string">&quot;殷浩&quot;</span>, <span class="string">&quot;0571-12345678&quot;</span>, <span class="string">&quot;浙江省杭州市余杭区文三西路969号&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.register(<span class="keyword">new</span> Name(<span class="string">&quot;殷浩&quot;</span>), <span class="keyword">new</span> PhoneNumber(<span class="string">&quot;0571-12345678&quot;</span>), <span class="keyword">new</span> Address(<span class="string">&quot;浙江省杭州市余杭区文三西路969号&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>通过以上 4 步，就能让你的代码变得更加简洁、优雅、健壮、安全。你还在等什么？今天就去尝试吧！</p>

        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/posts/5eda80fde4a399e5947ed558/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">阿里技术专家详解DDD系列 第二弹 - 应用架构</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/posts/5eda80cc6a87eb218a40878d/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">领域驱动设计在互联网业务开发中的实践-美团</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>&nbsp;-&nbsp;
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">ZhenYu</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
            <div class="icp-info info-item"><a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn">京ICP备18000555号-4</a></div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Domain-Primitive"><span class="nav-number">2.</span> <span class="nav-text">Domain Primitive</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.1.</span> <span class="nav-text">1案例分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">2.2.</span> <span class="nav-text">2解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8"><span class="nav-number">2.3.</span> <span class="nav-text">进阶使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A8%E8%AE%BA%E5%92%8C%E6%80%BB%E7%BB%93"><span class="nav-number">2.4.</span> <span class="nav-text">讨论和总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E6%88%98-%E8%80%81%E5%BA%94%E7%94%A8%E9%87%8D%E6%9E%84%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-number">2.5.</span> <span class="nav-text">实战 - 老应用重构的流程</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>








<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
